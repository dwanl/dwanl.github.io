<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui"
    />
    <title>异常处理 | 面试API</title>
    <meta name="description" content="前端面试API，自检清单，公众号推荐" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="异常处理 | 面试API" />
    <meta property="og:site_name" content="异常处理 | 面试API" />
    <meta property="og:locale" content="zh-CN" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="异常处理 | 面试API" />
    <link rel="shortut icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.ac80907d.css" as="style"><link rel="preload" href="/assets/js/app.aa10ff94.js" as="script"><link rel="preload" href="/assets/js/1.98983d17.js" as="script"><link rel="preload" href="/assets/js/6.ab6f709e.js" as="script"><link rel="preload" href="/assets/js/5.0f5d195d.js" as="script"><link rel="preload" href="/assets/js/8.3fb3d86d.js" as="script"><link rel="preload" href="/assets/js/11.f2ac282b.js" as="script"><link rel="preload" href="/assets/js/7.a46ab4a3.js" as="script"><link rel="preload" href="/assets/js/30.cb74671b.js" as="script"><link rel="preload" href="/assets/js/16.cc873b0d.js" as="script"><link rel="prefetch" href="/assets/js/10.175139c9.js"><link rel="prefetch" href="/assets/js/12.05f5c451.js"><link rel="prefetch" href="/assets/js/13.c7679de2.js"><link rel="prefetch" href="/assets/js/14.7ca15e66.js"><link rel="prefetch" href="/assets/js/15.ee045e63.js"><link rel="prefetch" href="/assets/js/17.c9beec15.js"><link rel="prefetch" href="/assets/js/18.a55fa89e.js"><link rel="prefetch" href="/assets/js/19.6a1d7086.js"><link rel="prefetch" href="/assets/js/20.3e55f9ce.js"><link rel="prefetch" href="/assets/js/21.59252230.js"><link rel="prefetch" href="/assets/js/22.512ab14f.js"><link rel="prefetch" href="/assets/js/23.f6fa4555.js"><link rel="prefetch" href="/assets/js/24.f48149e7.js"><link rel="prefetch" href="/assets/js/25.ba77482f.js"><link rel="prefetch" href="/assets/js/26.80224386.js"><link rel="prefetch" href="/assets/js/27.c88887c5.js"><link rel="prefetch" href="/assets/js/28.b8ef49b8.js"><link rel="prefetch" href="/assets/js/29.8b4c2fe5.js"><link rel="prefetch" href="/assets/js/31.4678b577.js"><link rel="prefetch" href="/assets/js/32.89170fab.js"><link rel="prefetch" href="/assets/js/33.61c8bfb1.js"><link rel="prefetch" href="/assets/js/34.bd2994fa.js"><link rel="prefetch" href="/assets/js/35.e0c15a4b.js"><link rel="prefetch" href="/assets/js/36.9397409c.js"><link rel="prefetch" href="/assets/js/37.0cc5347f.js"><link rel="prefetch" href="/assets/js/38.b0587cce.js"><link rel="prefetch" href="/assets/js/39.ab57e929.js"><link rel="prefetch" href="/assets/js/4.2b5d276e.js"><link rel="prefetch" href="/assets/js/40.40636fe9.js"><link rel="prefetch" href="/assets/js/41.ad6b90ff.js"><link rel="prefetch" href="/assets/js/42.fe0c537f.js"><link rel="prefetch" href="/assets/js/43.acbb76e9.js"><link rel="prefetch" href="/assets/js/44.5e509551.js"><link rel="prefetch" href="/assets/js/45.7ff401ec.js"><link rel="prefetch" href="/assets/js/46.a3ef0e16.js"><link rel="prefetch" href="/assets/js/47.acf9fb42.js"><link rel="prefetch" href="/assets/js/48.5aaf9ba4.js"><link rel="prefetch" href="/assets/js/49.7395ec25.js"><link rel="prefetch" href="/assets/js/50.38af9ea8.js"><link rel="prefetch" href="/assets/js/51.5e7cd43d.js"><link rel="prefetch" href="/assets/js/52.194d866b.js"><link rel="prefetch" href="/assets/js/53.2f365219.js"><link rel="prefetch" href="/assets/js/54.5f11479b.js"><link rel="prefetch" href="/assets/js/55.de87f24c.js"><link rel="prefetch" href="/assets/js/56.b9d0fd0a.js"><link rel="prefetch" href="/assets/js/57.84b1d236.js"><link rel="prefetch" href="/assets/js/58.193c604b.js"><link rel="prefetch" href="/assets/js/59.03a58c3a.js"><link rel="prefetch" href="/assets/js/60.b74aa8aa.js"><link rel="prefetch" href="/assets/js/61.f9cb38ac.js"><link rel="prefetch" href="/assets/js/62.15fdaafb.js"><link rel="prefetch" href="/assets/js/63.c4dffc08.js"><link rel="prefetch" href="/assets/js/64.e5336627.js"><link rel="prefetch" href="/assets/js/65.f33b92bf.js"><link rel="prefetch" href="/assets/js/66.59a15093.js"><link rel="prefetch" href="/assets/js/67.2c628934.js"><link rel="prefetch" href="/assets/js/68.b44a894d.js"><link rel="prefetch" href="/assets/js/9.ba7c49dc.js"><link rel="prefetch" href="/assets/js/search.7618a20d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ac80907d.css">
  </head>
  <body>
    <div id="loader-wrapper" style="display: none;opacity:0">
      <div id="loader"></div>
      <div class="loader-section section-left"></div>
      <div class="loader-section section-right"></div>
    </div>
    <div id="app" data-server-rendered="true"><div data-v-8ae45032><section class="el-container" data-v-8ae45032><aside width="200px" class="el-aside menu" style="width:auto;" data-v-28ba16cc data-v-8ae45032><div class="brand-wrap" style="background-image:url(/aside.jpg);" data-v-28ba16cc><div class="brand" data-v-28ba16cc><a href="/" class="avatar waves-effect waves-circle waves-light router-link-active" data-v-28ba16cc><img src="/infoq1.png" data-v-28ba16cc></a> <hgroup class="introduce" data-v-28ba16cc><div class="nickname" data-v-28ba16cc><img src="/name.png" data-v-28ba16cc></div> <div data-v-28ba16cc><a title="253929992@qq.com" class="mail" data-v-28ba16cc>253929992@qq.com</a></div></hgroup></div></div> <ul role="menubar" class="menu-wrap el-menu" style="background-color:;" data-v-28ba16cc><li role="menuitem" aria-haspopup="true" aria-expanded="true" class="el-submenu is-opened" data-v-28ba16cc><div class="el-submenu__title" style="padding-left:20px;color:;background-color:;"><i class="iconfont icon-icon37" data-v-28ba16cc></i> <span slot="title" class="item-title" data-v-28ba16cc>自检清单</span><i class="el-submenu__icon-arrow el-icon-arrow-down"></i></div><ul role="menu" class="el-menu el-menu--inline" style="background-color:;"> <li role="menuitem" tabindex="-1" default-active="1" class="el-menu-item" style="padding-left:40px;color:;background-color:;" data-v-28ba16cc><i class="el-icon-news" data-v-28ba16cc></i> <span class="item-title" data-v-28ba16cc>
            JS基础
          </span></li><li role="menuitem" tabindex="-1" default-active="1" class="el-menu-item" style="padding-left:40px;color:;background-color:;" data-v-28ba16cc><i class="el-icon-news" data-v-28ba16cc></i> <span class="item-title" data-v-28ba16cc>
            HTML&amp;CSS
          </span></li><li role="menuitem" tabindex="-1" default-active="1" class="el-menu-item" style="padding-left:40px;color:;background-color:;" data-v-28ba16cc><i class="el-icon-news" data-v-28ba16cc></i> <span class="item-title" data-v-28ba16cc>
            计算机基础
          </span></li><li role="menuitem" tabindex="-1" default-active="1" class="el-menu-item" style="padding-left:40px;color:;background-color:;" data-v-28ba16cc><i class="el-icon-news" data-v-28ba16cc></i> <span class="item-title" data-v-28ba16cc>
            数据结构和算法
          </span></li><li role="menuitem" tabindex="-1" default-active="1" class="el-menu-item" style="padding-left:40px;color:;background-color:;" data-v-28ba16cc><i class="el-icon-news" data-v-28ba16cc></i> <span class="item-title" data-v-28ba16cc>
            运行环境
          </span></li><li role="menuitem" tabindex="-1" default-active="1" class="el-menu-item" style="padding-left:40px;color:;background-color:;" data-v-28ba16cc><i class="el-icon-news" data-v-28ba16cc></i> <span class="item-title" data-v-28ba16cc>
            框架
          </span></li><li role="menuitem" tabindex="-1" default-active="1" class="el-menu-item" style="padding-left:40px;color:;background-color:;" data-v-28ba16cc><i class="el-icon-news" data-v-28ba16cc></i> <span class="item-title" data-v-28ba16cc>
            工程化
          </span></li></ul></li><li role="menuitem" tabindex="-1" class="el-menu-item" style="padding-left:20px;color:;background-color:;" data-v-28ba16cc><i class="iconfont icon-shijianzhou" data-v-28ba16cc></i> <span class="item-title" data-v-28ba16cc>
        时间轴
      </span></li><li role="menuitem" tabindex="-1" class="el-menu-item" style="padding-left:20px;color:;background-color:;" data-v-28ba16cc><i class="iconfont icon-guanyu" data-v-28ba16cc></i> <span class="item-title" data-v-28ba16cc>
        个人档案
      </span></li></ul></aside> <section class="el-container container-warp" data-v-8ae45032><header id="topHeader" class="el-header top-header" style="height:60px;padding-left:300px;" data-v-7e316482 data-v-8ae45032><div class="header-warp el-row is-align-center el-row--flex" data-v-7e316482><div class="el-col el-col-2 el-col-xs-7" data-v-7e316482><button type="button" class="el-button header-btn el-button--primary el-button--mini is-circle" data-v-7e316482><!----><!----><span><i class="iconfont icon-rightjustified" data-v-7e316482></i></span></button></div> <div class="el-col el-col-10 el-col-xs-24" data-v-7e316482><div aria-haspopup="listbox" role="combobox" aria-owns="el-autocomplete-8041" class="el-autocomplete search-input" data-v-7e316482><div class="el-input el-input--small el-input--suffix"><!----><input type="text" autocomplete="off" valueKey="value" popperClass="search-popper" placeholder="搜搜看" fetchSuggestions="function () { [native code] }" debounce="300" placement="bottom-start" popperAppendToBody="true" value="" class="el-input__inner"><!----><span class="el-input__suffix"><span class="el-input__suffix-inner"><i class="el-input__icon el-icon-search search-ico" data-v-7e316482></i><!----></span><!----></span><!----></div><div role="region" class="el-autocomplete-suggestion el-popper search-popper" style="width:;display:none;"><div class="el-scrollbar"><div class="el-autocomplete-suggestion__wrap el-scrollbar__wrap el-scrollbar__wrap--hidden-default"><ul class="el-scrollbar__view el-autocomplete-suggestion__list"></ul></div><div class="el-scrollbar__bar is-horizontal"><div class="el-scrollbar__thumb" style="width:0;transform:translateX(0%);ms-transform:translateX(0%);webkit-transform:translateX(0%);"></div></div><div class="el-scrollbar__bar is-vertical"><div class="el-scrollbar__thumb" style="height:0;transform:translateY(0%);ms-transform:translateY(0%);webkit-transform:translateY(0%);"></div></div></div></div></div></div> <div class="nav-col el-col el-col-8 el-col-offset-10 el-col-xs-24" data-v-7e316482><ul role="menubar" class="header-menu el-menu--horizontal el-menu" style="background-color:transparent;" data-v-7e316482><li role="menuitem" tabindex="-1" class="el-menu-item" style="color:#fdf5ab;border-bottom-color:transparent;background-color:transparent;" data-v-7e316482>Home</li><li role="menuitem" tabindex="-1" class="el-menu-item is-active" style="color:#ffd04b;border-bottom-color:#ffd04b;background-color:transparent;" data-v-7e316482>Blog</li></ul></div></div></header> <main class="el-main my-main" style="margin-left:238px;" data-v-47f536a8 data-v-8ae45032><div class="content-header index-header" style="background-image:url(/banner.jpg);" data-v-1ba67baf data-v-47f536a8><div class="container" data-v-1ba67baf><h1 id="conentHeader" class="title animated fadeInDown" data-v-1ba67baf>异常处理</h1> <h5 class="subtitle" data-v-1ba67baf>最后更新时间：2019-11-21 16:13:47</h5> <div class="el-row is-align-center el-row--flex" data-v-47f536a8><div class="tag-card el-col el-col-20 el-col-xs-23 el-col-sm-22 el-col-md-22 el-col-lg-20" data-v-47f536a8><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>AST抽象语法树</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>this</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>CSS渲染原理</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>高阶函数</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>判断数据类型</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>执行上下文</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>浏览器缓存</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>编译原理</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>闭包</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>性能优化</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>回流与重绘</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>HTML汇总</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>CSS选择器</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>CSS伪类</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>BFC</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>垂直居中</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>CSS盒模型</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>CSS</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>三栏布局</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>Vue组件通信</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>实现轮子</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>数据结构</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>版本控制</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>编码能力</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>网络协议</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>React</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>算法</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>项目构建</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>开发提速</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>Nginx</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>数据流管理</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>持续集成</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>Vue</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>TypeScript</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>异常处理</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>基础问题</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>Symbol</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>类型转换</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>作用域</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>执行机制</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>正则表达式</span><span class="animated fadeInRight el-tag el-tag--medium is-hit" data-v-47f536a8>原型和原型链</span></div></div></div></div> <div data-v-3a18dd0a data-v-47f536a8 data-v-47f536a8><div class="post-content el-row is-justify-center el-row--flex" data-v-3a18dd0a><div id="post-card" class="post-card post-sign el-col el-col-16 el-col-xs-24 el-col-sm-23 el-col-md-23 el-col-lg-16" data-v-3a18dd0a><div class="content__default" data-v-3a18dd0a><h1 id="如何优雅的处理前端异常？"><a href="#如何优雅的处理前端异常？" aria-hidden="true" class="header-anchor">#</a> 如何优雅的处理前端异常？</h1> <p>转自：<a href="http://jartto.wang/2018/11/20/js-exception-handling/index.html" target="_blank" rel="noopener noreferrer">如何优雅处理前端异常？<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>作者：<a href="http://jartto.wang/" target="_blank" rel="noopener noreferrer">Jartto<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="为什么要处理异常？"><a href="#为什么要处理异常？" aria-hidden="true" class="header-anchor">#</a> 为什么要处理异常？</h2> <blockquote><p>异常是不可控的，会影响最终的呈现结果，但是我们有充分的理由去做这样的事情。</p></blockquote> <ol><li>增强用户体验。</li> <li>远程定位问题。</li> <li>未雨绸缪，及早发现问题。</li> <li>无法复现问题，尤其是移动端，机型，系统都是问题。</li> <li>完善的前端方案，前端监控系统。</li></ol> <p>对于 <code>JS</code> 而言，我们面对的仅仅只是异常，异常的出现不会直接导致 <code>JS</code> 引擎崩溃，最多只会使当前执行的任务终止。</p> <h2 id="需要处理哪些异常？"><a href="#需要处理哪些异常？" aria-hidden="true" class="header-anchor">#</a> 需要处理哪些异常？</h2> <p>对于前端来说，我们可做的异常捕获还真不少。总结一下，大概如下：</p> <ul><li><code>JS</code> 语法错误、代码异常。</li> <li><code>AJAX</code> 请求异常。</li> <li>静态资源加载异常。</li> <li><code>Promise</code> 异常。</li> <li><code>Iframe</code> 异常。</li> <li>跨域 <code>Script error</code>。</li> <li>崩溃和卡顿。</li></ul> <p>下面我会针对每种具体情况来说明如何处理这些异常。</p> <h2 id="try-catch-的误区"><a href="#try-catch-的误区" aria-hidden="true" class="header-anchor">#</a> Try-Catch 的误区</h2> <p><code>try-catch</code> 只能捕获到同步的运行时错误，对语法和异步错误却无能为力，捕获不到。</p> <p>1.只能捕获同步运行时错误</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token string">'jartto'</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>nam<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'捕获到异常：'</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>输出：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>    捕获到异常： ReferenceError<span class="token punctuation">:</span> nam is not defined
        at <span class="token operator">&lt;</span>anonymous<span class="token operator">&gt;</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">15</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>2.不能捕获到语法错误，我们修改一下代码，删掉一个单引号：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> name <span class="token operator">=</span> 'jartto<span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>nam<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'捕获到异常：'</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>输出：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Uncaught SyntaxError<span class="token punctuation">:</span> Invalid or unexpected token
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><em>不过语法错误在我们开发阶段就可以看到，应该不会顺利上到线上环境。</em></p> <p>3.异步错误</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">undefined</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=&gt;</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'捕获到异常：'</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>我们看看日志：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Uncaught TypeError<span class="token punctuation">:</span> Cannot read property <span class="token string">'map'</span> <span class="token keyword">of</span> <span class="token keyword">undefined</span>
    at <span class="token function">setTimeout</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>anonymous<span class="token operator">&gt;</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">11</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>并没有捕获到异常，这是需要我们特别注意的地方。</p> <h2 id="window-onerror-不是万能的"><a href="#window-onerror-不是万能的" aria-hidden="true" class="header-anchor">#</a> window.onerror 不是万能的</h2> <p>当 <code>JS</code> 发生运行时错误时，<code>window</code> 会触发 <code>ErrorEvent</code> 接口的 <code>error</code> 事件，并执行 <code>window.onerror()</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
* @param {String}  message    错误信息
* @param {String}  source    出错文件
* @param {Number}  lineno    行号
* @param {Number}  colno    列号
* @param {Object}  error  Error对象（对象）
*/</span>
window<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> source<span class="token punctuation">,</span> lineno<span class="token punctuation">,</span> colno<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'捕获到异常：'</span><span class="token punctuation">,</span><span class="token punctuation">{</span> message<span class="token punctuation">,</span> source<span class="token punctuation">,</span> lineno<span class="token punctuation">,</span> colno<span class="token punctuation">,</span> error <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>1.首先试试同步运行时错误</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> source<span class="token punctuation">,</span> lineno<span class="token punctuation">,</span> colno<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// message：错误信息（字符串）。</span>
    <span class="token comment">// source：发生错误的脚本URL（字符串）</span>
    <span class="token comment">// lineno：发生错误的行号（数字）</span>
    <span class="token comment">// colno：发生错误的列号（数字）</span>
    <span class="token comment">// error：Error对象（对象）</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'捕获到异常：'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> message<span class="token punctuation">,</span> source<span class="token punctuation">,</span> lineno<span class="token punctuation">,</span> colno<span class="token punctuation">,</span> error <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
Jartto<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>可以看到，我们捕获到了异常：</p> <p><img src="https://qiniu.mdnice.com/9df3c9c44449c798ba4966d4c1accbd5.png" alt="onerror"></p> <p>2.再试试语法错误呢？</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> source<span class="token punctuation">,</span> lineno<span class="token punctuation">,</span> colno<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'捕获到异常：'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>message<span class="token punctuation">,</span> source<span class="token punctuation">,</span> lineno<span class="token punctuation">,</span> colno<span class="token punctuation">,</span> error<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> name <span class="token operator">=</span> 'Jartto
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>控制台打印出了这样的异常：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Uncaught SyntaxError<span class="token punctuation">:</span> Invalid or unexpected token
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>什么，竟然没有捕获到语法错误？</p></blockquote> <p>3.怀着忐忑的心，我们最后来试试异步运行时错误：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> source<span class="token punctuation">,</span> lineno<span class="token punctuation">,</span> colno<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'捕获到异常：'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>message<span class="token punctuation">,</span> source<span class="token punctuation">,</span> lineno<span class="token punctuation">,</span> colno<span class="token punctuation">,</span> error<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    Jartto<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>控制台输出了：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>捕获到异常： <span class="token punctuation">{</span>message<span class="token punctuation">:</span> <span class="token string">&quot;Uncaught ReferenceError: Jartto is not defined&quot;</span><span class="token punctuation">,</span> source<span class="token punctuation">:</span> <span class="token string">&quot;http://127.0.0.1:8001/&quot;</span><span class="token punctuation">,</span> lineno<span class="token punctuation">:</span> <span class="token number">36</span><span class="token punctuation">,</span> colno<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> error<span class="token punctuation">:</span> ReferenceError<span class="token punctuation">:</span> Jartto is not defined
    at <span class="token function">setTimeout</span> <span class="token punctuation">(</span>http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">8001</span><span class="token operator">/</span><span class="token punctuation">:</span><span class="token number">36</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>4.接着，我们试试网络请求异常的情况：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
window<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> source<span class="token punctuation">,</span> lineno<span class="token punctuation">,</span> colno<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'捕获到异常：'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>message<span class="token punctuation">,</span> source<span class="token punctuation">,</span> lineno<span class="token punctuation">,</span> colno<span class="token punctuation">,</span> error<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>img src<span class="token operator">=</span><span class="token string">&quot;./jartto.png&quot;</span><span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><blockquote><p>我们发现，不论是静态资源异常，或者接口异常，错误都无法捕获到。</p></blockquote> <p>补充一点：<code>window.onerror</code> 函数只有在返回 <code>true</code> 的时候，异常才不会向上抛出，否则即使是知道异常的发生控制台还是会显示 <code>Uncaught Error: xxxxx</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> source<span class="token punctuation">,</span> lineno<span class="token punctuation">,</span> colno<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'捕获到异常：'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>message<span class="token punctuation">,</span> source<span class="token punctuation">,</span> lineno<span class="token punctuation">,</span> colno<span class="token punctuation">,</span> error<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    Jartto<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>控制台就不会再有这样的错误了：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Uncaught ReferenceError<span class="token punctuation">:</span> Jartto is not defined
    at <span class="token function">setTimeout</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token number">36</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>需要注意：</p> <ul><li><code>onerror</code> 最好写在所有 <code>JS</code> 脚本的前面，否则有可能捕获不到错误。</li> <li><code>onerror</code> 无法捕获语法错误。</li></ul> <p>到这里基本就清晰了：在实际的使用过程中，<code>onerror</code> 主要是来捕获预料之外的错误，而 <code>try-catch</code> 则是用来在可预见情况下监控特定的错误，两者结合使用更加高效。</p> <blockquote><p>问题又来了，捕获不到静态资源加载异常怎么办？
当一项资源（如图片或脚本）加载失败，加载资源的元素会触发一个 <code>Event</code> 接口的 <code>error</code> 事件，并执行该元素上的 <code>onerror()</code> 处理函数。这些 <code>error</code> 事件不会向上冒泡到 <code>window</code>，不过（至少在 <code>Firefox</code> 中）能被单一的 <code>window.addEventListener</code> 捕获。</p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>scritp<span class="token operator">&gt;</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'捕获到异常：'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>img src<span class="token operator">=</span><span class="token string">&quot;./jartto.png&quot;</span><span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>控制台输出：</p> <p><img src="https://qiniu.mdnice.com/8b687377fe3fa092a745a3ca13091dfa.png" alt="捕获异常"></p> <p>由于网络请求异常不会事件冒泡，因此必须在捕获阶段将其捕捉到才行，但是这种方式虽然可以捕捉到网络请求的异常，但是无法判断 <code>HTTP</code> 的状态是 <code>404</code> 还是其他比如 <code>500</code> 等等，所以还需要配合服务端日志才进行排查分析才可以。</p> <p>需要注意：</p> <ul><li>不同浏览器下返回的 <code>error</code> 对象可能不同，需要注意兼容处理。</li> <li>需要注意避免 <code>addEventListener</code> 重复监听。</li></ul> <h2 id="promise-catch"><a href="#promise-catch" aria-hidden="true" class="header-anchor">#</a> Promise Catch</h2> <blockquote><p>在 promise 中使用 catch 可以非常方便的捕获到异步 error，这个很简单。</p></blockquote> <p>没有写 <code>catch</code> 的 <code>Promise</code> 中抛出的错误无法被 <code>onerror</code> 或 <code>try-catch</code> 捕获到，所以我们务必要在 <code>Promise</code> 中不要忘记写 <code>catch</code> 处理抛出的异常。</p> <p>解决方案： 为了防止有漏掉的 <code>Promise</code> 异常，建议在全局增加一个对 <code>unhandledrejection</code> 的监听，用来全局监听 <code>Uncaught Promise Error</code>。</p> <p>使用方式：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;unhandledrejection&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>我们继续来尝试一下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;unhandledrejection&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'捕获到异常：'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'promise error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>可以看到如下输出：</p> <p><img src="https://qiniu.mdnice.com/28f4eea6f9e6f66b091cc037a99229fc.png" alt="异常捕获"></p> <p>那如果对 <code>Promise</code> 不进行 <code>catch</code> 呢？</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;unhandledrejection&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'捕获到异常：'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'jartto: promise error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><blockquote><p>嗯，事实证明，也是会被正常捕获到的。</p></blockquote> <p>所以，正如我们上面所说，为了防止有漏掉的 <code>Promise</code> 异常，建议在全局增加一个对 <code>unhandledrejection</code> 的监听，用来全局监听 <code>Uncaught Promise Error</code>。</p> <p>补充一点：如果去掉控制台的异常显示，需要加上：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="vue-errorhandler"><a href="#vue-errorhandler" aria-hidden="true" class="header-anchor">#</a> VUE errorHandler</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token function-variable function">errorHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'通过vue errorHandler捕获的错误'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="react-异常捕获"><a href="#react-异常捕获" aria-hidden="true" class="header-anchor">#</a> React 异常捕获</h2> <p><code>React 16</code> 提供了一个内置函数 <code>componentDidCatch</code>，使用它可以非常简单的获取到 <code>react</code> 下的错误信息：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">componentDidCatch</span><span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> info</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>除此之外，我们可以了解一下：<code>error boundary</code>。
<code>UI</code> 的某部分引起的 <code>JS</code> 错误不应该破坏整个程序，为了帮 <code>React</code> 的使用者解决这个问题，<code>React 16</code> 介绍了一种关于错误边界（<code>error boundary</code>）的新观念。</p> <p>需要注意的是： error boundaries 并不会捕捉下面这些错误：</p> <ol><li>事件处理器。</li> <li>异步代码。</li> <li>服务端的渲染代码。</li> <li>在 <code>error boundaries</code> 区域内的错误。</li></ol> <p>我们来举一个小例子，在下面这个 <code>componentDIdCatch(error,info)</code> 里的类会变成一个 <code>error boundary</code>：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">ErrorBoundary</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> hasError<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
 
  <span class="token function">componentDidCatch</span><span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> info</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Display fallback UI</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> hasError<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// You can also log the error to an error reporting service</span>
    <span class="token function">logErrorToMyService</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
 
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>hasError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// You can render any custom fallback UI</span>
      <span class="token keyword">return</span> <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>Something went wrong<span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>然后我们像使用普通组件那样使用它：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>ErrorBoundary<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>MyWidget <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>ErrorBoundary<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><code>componentDidCatch()</code> 方法像 <code>JS</code> 的 <code>catch{}</code> 模块一样工作，但是对于组件，只有 <code>class</code> 类型的组件可以成为一个 <code>error boundaries</code>。</p> <p>实际上，大多数情况下我们可以在整个程序中定义一个 <code>error boundary</code> 组件，之后就可以一直使用它了！</p> <h2 id="iframe-异常"><a href="#iframe-异常" aria-hidden="true" class="header-anchor">#</a> iframe 异常</h2> <p>对于 <code>iframe</code> 的异常捕获，我们还得借力 <code>window.onerror</code>：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> source<span class="token punctuation">,</span> lineno<span class="token punctuation">,</span> colno<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'捕获到异常：'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>message<span class="token punctuation">,</span> source<span class="token punctuation">,</span> lineno<span class="token punctuation">,</span> colno<span class="token punctuation">,</span> error<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>一个简单的例子可能如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>iframe src<span class="token operator">=</span><span class="token string">&quot;./iframe.html&quot;</span> frameborder<span class="token operator">=</span><span class="token string">&quot;0&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>iframe<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
  window<span class="token punctuation">.</span>frames<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> source<span class="token punctuation">,</span> lineno<span class="token punctuation">,</span> colno<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'捕获到 iframe 异常：'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>message<span class="token punctuation">,</span> source<span class="token punctuation">,</span> lineno<span class="token punctuation">,</span> colno<span class="token punctuation">,</span> error<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="script-error"><a href="#script-error" aria-hidden="true" class="header-anchor">#</a> Script error</h2> <p>一般情况，如果出现 <code>Script error</code> 这样的错误，基本上可以确定是出现了跨域问题。这时候，是不会有其他太多辅助信息的，但是解决思路无非如下：</p> <blockquote><p>跨源资源共享机制( CORS )：我们为 script 标签添加 crossOrigin 属性。</p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;http://jartto.wang/main.js&quot;</span> crossorigin<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>或者动态去添加 <code>js</code> 脚本：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
script<span class="token punctuation">.</span>crossOrigin <span class="token operator">=</span> <span class="token string">'anonymous'</span><span class="token punctuation">;</span>
script<span class="token punctuation">.</span>src <span class="token operator">=</span> url<span class="token punctuation">;</span>
document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p>特别注意，服务器端需要设置：Access-Control-Allow-Origin。</p></blockquote> <p>此外，我们也可以试试这个<a href="https://juejin.im/post/5c00a405f265da610e7fd024" target="_blank" rel="noopener noreferrer">解决 Script Error 的另类思路<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> originAddEventListener <span class="token operator">=</span> <span class="token class-name">EventTarget</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>addEventListener<span class="token punctuation">;</span>
<span class="token class-name">EventTarget</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">addEventListener</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> listener<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function-variable function">wrappedListener</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">listener</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">originAddEventListener</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> wrappedListener<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>简单解释一下：</p> <ul><li>改写了 <code>EventTarget</code> 的 <code>addEventListener</code> 方法。</li> <li>对传入的 <code>listener</code> 进行包装，返回包装过的 <code>listener</code>，对其执行进行 <code>try-catch</code>。</li> <li>浏览器不会对 <code>try-catch</code> 起来的异常进行跨域拦截，所以 <code>catch</code> 到的时候，是有堆栈信息的。</li> <li>重新 <code>throw</code> 出来异常的时候，执行的是同域代码，所以 <code>window.onerror</code> 捕获的时候不会丢失堆栈信息。</li></ul> <p>利用包装 <code>addEventListener</code>，我们还可以达到「扩展堆栈」的效果：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   <span class="token keyword">const</span> originAddEventListener <span class="token operator">=</span> <span class="token class-name">EventTarget</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>addEventListener<span class="token punctuation">;</span>
   <span class="token class-name">EventTarget</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">addEventListener</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> listener<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>    <span class="token comment">// 捕获添加事件时的堆栈</span>
<span class="token operator">+</span>    <span class="token keyword">const</span> addStack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Event (</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>stack<span class="token punctuation">;</span>
     <span class="token keyword">const</span> <span class="token function-variable function">wrappedListener</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token function">listener</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>        <span class="token comment">// 异常发生时，扩展堆栈</span>
<span class="token operator">+</span>        err<span class="token punctuation">.</span>stack <span class="token operator">+=</span> <span class="token string">'\n'</span> <span class="token operator">+</span> addStack<span class="token punctuation">;</span>
         <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
     <span class="token keyword">return</span> <span class="token function">originAddEventListener</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> wrappedListener<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h2 id="崩溃和卡顿"><a href="#崩溃和卡顿" aria-hidden="true" class="header-anchor">#</a> 崩溃和卡顿</h2> <p>卡顿也就是网页暂时响应比较慢，<code>JS</code> 可能无法及时执行。但崩溃就不一样了，网页都崩溃了，<code>JS</code> 都不运行了，还有什么办法可以监控网页的崩溃，并将网页崩溃上报呢？</p> <blockquote><p>崩溃和卡顿也是不可忽视的，也许会导致你的用户流失。</p></blockquote> <p>1.利用 <code>window</code> 对象的 <code>load</code> 和 <code>beforeunload</code> 事件实现了网页崩溃的监控。
不错的文章，推荐阅读：<a href="http://jasonjl.me/blog/2015/06/21/taking-action-on-browser-crashes/" target="_blank" rel="noopener noreferrer">Logging Information on Browser Crashes<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sessionStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'good_exit'</span><span class="token punctuation">,</span> <span class="token string">'pending'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sessionStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'time_before_crash'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'beforeunload'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sessionStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'good_exit'</span><span class="token punctuation">,</span> <span class="token string">'true'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span>sessionStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'good_exit'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    sessionStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'good_exit'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">'true'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/*
        insert crash logging code here
    */</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Hey, welcome back from your crash, looks like you crashed on: '</span> <span class="token operator">+</span> sessionStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'time_before_crash'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>2.基于以下原因，我们可以使用 <code>Service Worker</code> 来实现<a href="https://juejin.im/entry/5be158116fb9a049c6434f4a?utm_source=gold_browser_extension" target="_blank" rel="noopener noreferrer">网页崩溃的监控<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：</p> <ul><li><code>Service Worker</code> 有自己独立的工作线程，与网页区分开，网页崩溃了，<code>Service Worker</code> 一般情况下不会崩溃。</li> <li><code>Service Worker</code> 生命周期一般要比网页还要长，可以用来监控网页的状态。
网页可以通过 <code>navigator.serviceWorker.controller.postMessage API</code> 向掌管自己的 <code>SW</code> 发送消息。</li></ul> <h2 id="错误上报"><a href="#错误上报" aria-hidden="true" class="header-anchor">#</a> 错误上报</h2> <p>1.通过 <code>Ajax</code> 发送数据</p> <p>因为 <code>Ajax</code> 请求本身也有可能会发生异常，而且有可能会引发跨域问题，一般情况下更推荐使用动态创建 <code>img</code> 标签的形式进行上报。</p> <p>2.动态创建 <code>img</code> 标签的形式</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">report</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> reportUrl <span class="token operator">=</span> <span class="token string">'http://jartto.wang/report'</span><span class="token punctuation">;</span>
  <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>reportUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?logs=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>收集异常信息量太多，怎么办？实际中，我们不得不考虑这样一种情况：如果你的网站访问量很大，那么一个必然的错误发送的信息就有很多条，这时候，我们需要设置采集率，从而<a href="https://github.com/happylindz/blog/issues/5" target="_blank" rel="noopener noreferrer">减缓服务器的压力<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Reporter<span class="token punctuation">.</span><span class="token function-variable function">send</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 只采集 30%</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">send</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>      <span class="token comment">// 上报错误信息</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><blockquote><p>采集率应该通过实际情况来设定，随机数，或者某些用户特征都是不错的选择。</p></blockquote> <h2 id="总结"><a href="#总结" aria-hidden="true" class="header-anchor">#</a> 总结</h2> <p>回到我们开头提出的那个问题，如何优雅的处理异常呢？</p> <ol><li>可疑区域增加 <code>Try-Catch</code>。</li> <li>全局监控 <code>JS</code> 异常 <code>window.onerror</code>。</li> <li>全局监控静态资源异常 <code>window.addEventListener</code>。</li> <li>捕获没有 <code>Catch</code> 的 <code>Promise</code> 异常：<code>unhandledrejection</code>。</li> <li><code>VUE errorHandler</code> 和 <code>React componentDidCatch</code>。</li> <li>监控网页崩溃：<code>window</code> 对象的 <code>load</code> 和 <code>beforeunload</code>。</li> <li>跨域 <code>crossOrigin</code> 解决。</li></ol> <p>其实很简单，正如上文所说：采用组合方案，分类型的去捕获异常，这样基本 80%-90% 的问题都化于无形。</p></div> <span id="footerPost" data-v-3a18dd0a></span></div> <div id="post-toc" class="post-toc el-col el-col-6" data-v-3a18dd0a><div class="catalog-body" data-v-3a18dd0a><h4 class="catalog-title" data-v-3a18dd0a>目录</h4> <ul id="catalog-list" class="catalog-list" data-v-3a18dd0a></ul></div></div></div> <div class="el-row is-justify-center el-row--flex" data-v-3a18dd0a><div class="post-card vssue-wrap el-col el-col-21 el-col-xs-24 el-col-sm-23 el-col-md-23 el-col-lg-16" data-v-3a18dd0a></div></div> <div class="post-nav el-row is-justify-space-around el-row--flex" data-v-3a18dd0a><div class="post-prev el-col el-col-7" data-v-3a18dd0a><div data-v-3a18dd0a><a href="/posts/Chapter6/TypeScript.html" data-v-3a18dd0a><i class="el-icon-arrow-left" data-v-3a18dd0a></i> Prev
        </a> <p class="nav-title" data-v-3a18dd0a>TypeScript</p></div></div> <div class="post-next el-col el-col-7 el-col-lg-pull-5" data-v-3a18dd0a><div data-v-3a18dd0a><a href="/posts/Chapter1/" class="router-link-active" data-v-3a18dd0a>
          Next
          <i class="el-icon-arrow-right" data-v-3a18dd0a></i></a> <p class="nav-title router-link-active" data-v-3a18dd0a>基础问题</p></div></div></div> <span data-v-3f1acc1c data-v-3a18dd0a><button type="button" class="el-button toc-btn el-button--primary el-button--mini is-circle" data-v-3f1acc1c><!----><!----><span><i class="el-icon-tickets" data-v-3f1acc1c></i></span></button> <button type="button" class="el-button gotop-btn el-button--primary is-circle" data-v-3f1acc1c><!----><!----><span><i class="el-icon-arrow-up" data-v-3f1acc1c></i></span></button></span></div></main></section> <button type="button" class="el-button gotop-btn el-button--primary is-circle" style="display:none;" data-v-1918517c data-v-8ae45032><!----><!----><span><i class="el-icon-arrow-up" data-v-1918517c></i></span></button></section> <div class="overlay" data-v-8ae45032></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.aa10ff94.js" defer></script><script src="/assets/js/1.98983d17.js" defer></script><script src="/assets/js/6.ab6f709e.js" defer></script><script src="/assets/js/5.0f5d195d.js" defer></script><script src="/assets/js/8.3fb3d86d.js" defer></script><script src="/assets/js/11.f2ac282b.js" defer></script><script src="/assets/js/7.a46ab4a3.js" defer></script><script src="/assets/js/30.cb74671b.js" defer></script><script src="/assets/js/16.cc873b0d.js" defer></script>
  </body>
</html>
